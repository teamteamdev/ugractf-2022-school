"use strict";!function(){function trimLetters(value,start,end){if(!_.isString(value))return value;var output=value;if(start){var r=new RegExp("^"+start+"+","g");output=output.replace(r,"")}if(end){var _r=new RegExp(end+"+$","g");output=output.replace(_r,"")}return output}angular.module("app").controllerProvider.register("SummaryCtrl",["$rootScope","$scope","$state","$parse","$q","devinfo","device","funcs","translate","cookie","ngDialog","summaryConstants","summaryLinks","summaryYandexDns","summaryCpuRam","somovd","cpe","snackbars","navigationFilter","$injector","$http",function($rootScope,$scope,$state,$parse,$q,devinfo,device,funcs,translate,cookie,ngDialog,constants,links,summaryYandexDns,summaryCpuRam,somovd,cpe,snackbars,navigationFilter,$injector,$http){function collectAreas(areas){return _.pluck(areas,"area").join("|")}function collectHandlers(areas){return _.filter(_.pluck(areas,"handler"),function(handler){return _.isFunction(handler)}),function(response){_.each(areas,function(areaDesc){_.isFunction(areaDesc.handler)&&areaDesc.handler(response,areaDesc.area)})}}function devinfoHandler(data){function getUptimePrepared(s){var result={};return result.d=s/86400|0,result.h=formatTimeElement(s%86400/3600|0),result.m=formatTimeElement(s%3600/60|0),result.s=formatTimeElement(s%60),result}function formatTimeElement(n){return n>9?n:"0"+n}function getValOrKey(obj,key){return key in obj?obj[key]:key}function convertWan(wan){if(wan){var result={connectionType:wan.contype,ip:wan.ip,ipv6:wan.ipv6};return wan.status&&(result.status=getWanStatus(wan),result.statusDescription=wan.status?getStatusKey(wan.status,wan.odu_status):"-"),result}}function getWanStatus(wan){return"Connected"===wan.status||"KabinetFull"==wan.status||"KabinetNetworksOnly"==wan.status?"on":"Connecting"===wan.status?"pending":"CableDisconnected"===wan.status||"USBDisconnected"===wan.status||"WiFiDisconnect"===wan.status||"WiFiDisconnected"===wan.status||"USBNotActive"==wan.status?"disconnected":"off"}function getStatusKey(str){var key=null;if(!str)return"";switch(str){case"Disabled":key="st_disabled";break;case"DslDown":key="off";break;case"Connected":key="connected";break;case"kabinet_not_started":case"Disconnected":key="disconnected";break;default:str=str.replace(/PPP|WiFi|USB|DHCP|IP/g,function(i){return i[0]+i.slice(1).toLowerCase()}),key="wan_status_"+str.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}return key}function getBuildNotes(){switch(data.buildNotes){case"devInfoPromVers":return"summary_warn_inter_vers";case"devInfoEmulVers":return"summary_warn_emul_vers";case"devInfoTestVers":return"summary_warn_test_vers";case"devInfoBeCloud":return"summary_warn_becloud_vers";default:return data.buildNotes}}var mode;data&&Object.keys(data).length>1&&($scope.devInfo={fw_device_id:data.modelId,fw_name:data.modelName,fw_vendor:_.isUndefined(rules.SummaryReplaceVendor)?data.vendor:rules.SummaryReplaceVendor,fw_buildDate:getLocalDate(data.buildDate,data.lang)?getLocalDate(data.buildDate,data.lang):data.buildDate,fw_buildNotes:getBuildNotes(),fw_serialNumber:data.serialNumber,fw_version:data.version,fw_bugs:_.isUndefined(rules.SummaryReplaceMail)?data.supportMail:rules.SummaryReplaceMail,fw_tel:_.isUndefined(rules.SummaryReplaceTel)?data.supportTel:rules.SummaryReplaceTel,fw_service_tel:_.isUndefined(rules.SummaryReplaceServiceTel)?data.serviceTel:rules.SummaryReplaceServiceTel,fw_site:_.isUndefined(rules.SummaryReplaceSite)?data.supportSite:rules.SummaryReplaceSite,fw_address:_.isUndefined(rules.SummaryReplaceAddress)?null:rules.SummaryReplaceAddress,fw_subdepart_tel:_.isUndefined(rules.SummarySubDepart)?null:rules.SummarySubDepart,hwRevision:data.hwRevision,uptimeRaw:data.uptime,kernelHash:data.kernelHash,rootfsHash:data.rootfsHash,bootHash:data.bootHash,bootVersion:data.bootVersion},/ /.test($scope.devInfo.fw_tel)&&rules.multiSupportTel&&($scope.devInfo.fw_tel=$scope.devInfo.fw_tel.split(" "),$scope.devInfo.multiSupportTel=!0),mode=data&&data[112]&&data[112].device_mode?data[112].device_mode:cookie.get("device_mode"),$scope.isAp="ap"==mode,$scope.deviceMode=mode in modesList?modesList[mode]:null,$scope.uptime=getUptimePrepared($scope.devInfo.uptimeRaw),data.wifi_general&&($scope.wifiInfo={},["f24","f5"].forEach(function(freq){var _broadcast=_.isBoolean(data.wifi_general[freq].broadcast),broadcastLed="on",broadcast="on";!data.wifi_general[freq].radio&&data.wifi_general[freq].broadcast||!data.wifi_general[freq].radio&&!data.wifi_general[freq].broadcast?(broadcastLed="disconnected",broadcast="off"):data.wifi_general[freq].radio&&!data.wifi_general[freq].broadcast&&(broadcastLed="off",broadcast="off"),$scope.wifiInfo[freq]={exists:data.wifi_general[freq].exists,status:data.wifi_general[freq].radio,broadcast:broadcast,broadcastLed:broadcastLed,guestNetCount:data.wifi_general[freq].guestNetCount,statusProvider:_broadcast?"broadcast":"status",ssid:data.wifi_general[freq].ssid,authMode:getValOrKey(authModes,data.wifi_general[freq].authMode)}})),$scope.wanInfo={v4:convertWan(data.ipv4gw),v6:convertWan(data.ipv6gw)},$scope.lanInfo=$scope.lanInfo||{},$scope.lanInfo.exists=_.size(data.lan)>0,$scope.lanInfo.lanIp=_.size(data.lan)?data.lan[0].ip:"",$scope.lanInfo.lanIpv6=_.size(data.lan)?data.lan[0].ipv6:"",$scope.lanInfo.mac=_.size(data.lan)?data.lan[0].mac:"")}function devinfoClients(data){data&&Object.keys(data).length>1&&($scope.lanInfo=$scope.lanInfo||{},$scope.lanInfo.numberOfWirelessClients=data.numberOfWirelessClients,$scope.lanInfo.numberOfWiredClients=data.numberOfWiredClients)}function devinfoPorts(data){function getPortInfo(port){var num=/\d+$/.exec(port.name),name="";return name=port.alias?port.alias:num?"LAN"+num:port.name&&port.name.toUpperCase(),{name:name,status:!!port.status,management:!!port.management,speed:port.speed?port.speed:"",position:port.position}}function isUseSpeed(lanPorts){return _.some(lanPorts,function(port){return _.has(port,"speed")})}function getLanPorts(availPorts){return availPorts.filter(isLanPort)}function isLanPort(port){return!port.isWan&&("ethernet"===port.type||"fiber"===port.type)}var lanPorts;data&&Object.keys(data).length>1&&data.availPorts&&(lanPorts=getLanPorts(data.availPorts),$scope.lanInfo=$scope.lanInfo||{},$scope.lanInfo.ports=_.has(lanPorts[0],"position")?_.sortBy(_.map(lanPorts,getPortInfo),"position"):_.sortBy(_.map(lanPorts,getPortInfo),"name"),$scope.lanInfo.isUseSpeed=isUseSpeed(lanPorts),$scope.lanInfo.notPortsInfo=!_.has(data,"availPorts")||lanPorts&&0==lanPorts.length)}function getLocalDate(buildDate,lang){if(!buildDate||"undefined"==typeof Intl)return null;var temp=buildDate.split(" ");temp=_.without(temp,"");var date=new Date(temp[1]+" "+temp[2]+" "+temp[5]+" "+temp[3]);if("Invalid Date"==date)return null;var formatter=new Intl.DateTimeFormat({eng:"en",rus:"ru",ukr:"uk",heb:"he",tur:"tr",tat:"tt",arm:"hy",fra:"fr",ara:"ar",fas:"fa",kaz:"kk",lit:"lt",kor:"ko",ger:"de",spa:"es",por:"pt",ita:"it",chs:"zh-CN",cht:"zh-TW",eus:"eu"}[lang],{year:"numeric",month:"short",day:"numeric",weekday:"short",hour:"numeric",minute:"numeric",second:"numeric"}),readyData=formatter.format(date)+" "+temp[4];return readyData.replace(/,/g,"")}"ap"==cookie.get("device_mode");var summaryUsb=$injector.get("summaryUsb");window.devinfo=devinfo,$scope.constants=constants,$scope.links=links;var rules=navigationFilter.rules();$scope.customRules=rules;var authModes={OPEN:"Open",SHARED:"Shared",WPA:"WPA",WPAPSK:"WPA-PSK",WPA2:"WPA2",WPA2PSK:"WPA2-PSK",WPA1WPA2:"WPA/WPA2 mixed",WPAPSKWPA2PSK:"WPA-PSK/WPA2-PSK mixed"},modesList={ap:"extender",router:"router"},devinfoAreas={"short":[],"long":[]},devinfoHandlerAreas="version|net";devinfoHandlerAreas+="|wifi_general",devinfoAreas["short"].push({area:devinfoHandlerAreas,handler:devinfoHandler,subscribe:!0}),devinfoAreas["short"].push({area:""+constants.DEVICE_MODE_RPC,handler:function(data){$scope.hasHWModeSwitch=$parse("d["+constants.DEVICE_MODE_RPC+"].devmode_hw_switch_support")({d:data}),$scope.ledsEnable=$parse("d["+constants.DEVICE_MODE_RPC+"].leds_enable")({d:data}),_.isUndefined($scope.ledsEnable)&&($scope.ledsEnable=!0)},subscribe:!0}),rules.HideSummaryYandexDNS||($scope.yandexInfo=summaryYandexDns.get(),devinfoAreas["long"].push({area:$scope.yandexInfo.area,handler:$scope.yandexInfo.devinfoHandler,subscribe:!0}),$scope.yandexInfo.yandexEnabled=function(){var overlay=$scope.overlay.circular,overlayId=overlay.start();$scope.yandexInfo.toggleYandexDns()["finally"](overlay.stop.bind(overlay,overlayId))},$scope.yandexInfo.changeSettings=function(){var overlay=$scope.overlay.circular,overlayId=overlay.start();$scope.yandexInfo.updateSettings()["finally"](overlay.stop.bind(overlay,overlayId))}),devinfoAreas["long"].push({area:"clients|ports",handler:function(data){devinfoPorts(data),devinfoClients(data)},subscribe:!0}),$scope.usbInfo=summaryUsb.get(),devinfoAreas["long"].push({area:$scope.usbInfo.area,handler:$scope.usbInfo.devinfoHandler,subscribe:!0}),$scope.cpuram=summaryCpuRam.get(),devinfoAreas["long"].push({area:$scope.cpuram.area,handler:$scope.cpuram.devinfoHandler,subscribe:!0}),devinfo.init({min_interval:4,timeout:autoconf.BR2_PACKAGE_ANWEB_DSYSINIT?1e4:5e3}),function(){$http.get("/version.json").then(function(response){response.data&&($scope.uiVersion=response.data.uiVersion)})}();var subscribeAreaDescriptions={},subscribeAreas={},subscribeHandlers={};_.each(devinfoAreas,function(areas,name){subscribeAreaDescriptions[name]=_.where(devinfoAreas[name],{subscribe:!0}),subscribeAreas[name]=collectAreas(subscribeAreaDescriptions[name]),subscribeHandlers[name]=collectHandlers(subscribeAreaDescriptions[name])}),function(){var shortAreas=collectAreas(devinfoAreas["short"]);return devinfo.once(shortAreas).then(function(response){response&&collectHandlers(devinfoAreas["short"])(response),$scope.pageLoadSuccess=!0})["finally"](function(){shortAreas&&devinfo.subscribe(subscribeAreas["short"],subscribeHandlers["short"],$scope),$scope.isActivate=!0,$scope.$emit("pageload")})["catch"](function(){$scope.isActivate=!0,$scope.pageLoadSuccess=!1,$scope.$emit("pageload")})}(),function(){var longAreas=collectAreas(devinfoAreas["long"]);return devinfo.once(longAreas,{}).then(function(response){response&&(collectHandlers(devinfoAreas["long"])(response),$scope.longAreasReady=!0)})["finally"](function(){longAreas&&devinfo.longTimeout.subscribe(subscribeAreas["long"],function(response,areas){return $scope.longAreasReady=!0,subscribeHandlers["long"](response,areas)},$scope)})["catch"](function(){})}(),$scope.refreshSummary=function(){$state.go($state.current,{},{reload:!0})},$scope.openModeDialog=function(){ngDialog.open({template:"dialogs/modal_info/dialog.tpl.html",className:"modal_info_dialog",controller:"ModalInfoCtrl",resolve:funcs.getLazyResolve("dialogs/modal_info/ctrl.lazy.js","ModalInfoCtrl"),data:{header:"summary_devmode_mode_title",content:{hasHWModeSwitch:$scope.hasHWModeSwitch,deviceMode:$scope.deviceMode}}})},$scope.openCpuMemoryDialog=function(){ngDialog.open({template:"dialogs/cpu_memory_statistic/dialog.tpl.html",className:"cpu_memory_info_dialog",controller:"CpuMemoryCtrl",resolve:funcs.getLazyResolve("dialogs/cpu_memory_statistic/ctrl.lazy.js","CpuMemoryCtrl"),scope:$scope})},$scope.changeLedsDisable=function(ledsEnable){somovd.write(constants.DEVICE_MODE_RPC,{leds_enable:ledsEnable}).then(function(){return snackbars.add("msg_rpc_write_success")},function(){return snackbars.add("msg_rpc_write_error")})},$scope.getWANTitle=function(key){return"summary_wan_con_"+key},$scope.getDevModeName=function(){var mode="";return mode=angular.copy($scope.deviceMode),translate("summary_devmode_"+mode)}}]),angular.module("app").filterProvider.register("replaceHtmlEntities",function(){return function(input){var replace={"&nbsp;":" "},output=input;for(var key in replace)output=output.replace(key,replace[key]);return output}}),angular.module("app").filterProvider.register("trimLetters",function(){return trimLetters})}();